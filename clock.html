<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkTime Pro</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --bg: #050505; --card: #121212; --accent: #3d8bff; --text: #fff; --border: #222; }
        body { background: var(--bg); color: var(--text); font-family: system-ui; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 25px; width: 100%; max-width: 400px; margin-bottom: 20px; text-align: center; }
        .timer { font-size: 4rem; font-weight: 200; margin: 20px 0; font-variant-numeric: tabular-nums; }
        button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin: 5px 0; }
        .btn-in { background: #fff; color: #000; }
        .btn-out { background: transparent; color: #fff; border: 1px solid var(--border); }
        .history-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        input { background: #1a1a1a; border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 8px; width: 60px; text-align: center; }
        #loginOverlay { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <button onclick="login()" style="width: auto; padding: 15px 40px;">התחבר עם Google</button>
</div>

<div class="card">
    <div id="greeting" style="font-size: 1.2rem; margin-bottom: 10px;">שלום</div>
    <div class="timer" id="display">00:00:00</div>
    <button class="btn-in" onclick="punchIn()">כניסה</button>
    <button class="btn-out" onclick="punchOut()">סיום</button>
</div>

<div class="card">
    <div style="display:flex; justify-content: space-around; margin-bottom: 15px;">
        <div>₪/שעה: <input type="number" id="rate" value="50" onchange="updateSettings()"></div>
        <div>תקן: <input type="number" id="std" value="9.5" onchange="updateSettings()"></div>
    </div>
    <div id="historyList"></div>
    <div style="margin-top: 15px; font-weight: bold;">סה"כ חודשי: <span id="totalPay">₪0</span></div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyB6k04PIDrtH0lN1mMH8d4mrQbU_Wd6EPY", authDomain: "clooc-87768.firebaseapp.com", projectId: "clooc-87768", storageBucket: "clooc-87768.firebasestorage.app", messagingSenderId: "446568496274", appId: "1:446568496274:web:c1aead85e32d21d0e5ba4b" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.firestore();
    let user = null;

    async function login() { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

    auth.onAuthStateChanged(async u => {
        if(u) {
            user = u;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('greeting').innerText = `שלום, ${u.displayName.split(' ')[0]}`;
            await loadSettings();
            loadData();
            checkActive();
        }
    });

    async function updateSettings() {
        if(!user) return;
        const rate = document.getElementById('rate').value;
        const std = document.getElementById('std').value;
        await db.collection('users').doc(user.uid).set({ rate, std }, { merge: true });
    }

    async function loadSettings() {
        const doc = await db.collection('users').doc(user.uid).get();
        if(doc.exists) {
            document.getElementById('rate').value = doc.data().rate || 50;
            document.getElementById('std').value = doc.data().std || 9.5;
        }
    }

    function punchIn() {
        localStorage.setItem('start_time', new Date().toISOString());
        checkActive();
    }

    async function punchOut() {
        const start = localStorage.getItem('start_time');
        if(!start) return;
        const hours = (new Date() - new Date(start)) / 3600000;
        const rate = document.getElementById('rate').value;
        const pay = Math.round(hours * rate);
        
        await db.collection('users').doc(user.uid).collection('logs').add({
            date: new Date().toLocaleDateString('he-IL'),
            hours: hours.toFixed(2),
            pay: pay,
            timestamp: Date.now()
        });
        localStorage.removeItem('start_time');
        location.reload();
    }

    async function loadData() {
        const snap = await db.collection('users').doc(user.uid).collection('logs').orderBy('timestamp', 'desc').limit(10).get();
        let total = 0;
        document.getElementById('historyList').innerHTML = snap.docs.map(doc => {
            const d = doc.data();
            total += d.pay;
            return `<div class="history-item"><span>${d.date}</span><span>${d.hours} ש'</span><span>₪${d.pay}</span></div>`;
        }).join('');
        document.getElementById('totalPay').innerText = `₪${total}`;
    }

    function checkActive() {
        const start = localStorage.getItem('start_time');
        if(start) {
            setInterval(() => {
                const s = Math.floor((new Date() - new Date(start)) / 1000);
                document.getElementById('display').innerText = new Date(s * 1000).toISOString().substr(11, 8);
            }, 1000);
        }
    }
</script>
</body>
</html>
