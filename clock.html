<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WorkTime Ultra Fix</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --bg: #000; --card: #121212; --accent: #3478F6; --text: #fff; --danger: #FF3B30; --gray: #8E8E93; }
        * { box-sizing: border-box; font-family: -apple-system, system-ui; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #loginOverlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .header { padding: 40px 25px 10px; text-align: right; }
        .status-text { font-size: 2.5rem; font-weight: 700; margin-top: 10px; }
        .timer { font-size: 5rem; font-weight: 200; margin: 30px 0; font-variant-numeric: tabular-nums; color: var(--accent); text-align: center; }
        .timer.overtime { color: var(--danger); }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); width: 100%; max-width: 400px; text-align: center; margin: 0 auto 40px; }
        .stat-val { font-size: 1.1rem; font-weight: 600; display: block; }
        .stat-label { font-size: 0.7rem; color: var(--gray); margin-top: 4px; display: block; }
        .btn-main { width: 90%; max-width: 350px; padding: 18px; border-radius: 16px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; display: block; margin: 0 auto; }
        .btn-entry { background: #fff; color: #000; }
        .btn-exit { background: var(--danger); color: #fff; }
        .nav { background: #0A0A0A; border-top: 1px solid #1C1C1E; display: grid; grid-template-columns: repeat(3, 1fr); padding: 10px 0 30px; }
        .nav-item { text-align: center; color: var(--gray); font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; padding-bottom: 100px; }
        .screen.active { display: flex; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { padding: 18px 15px; border-bottom: 1px solid #1C1C1E; }
    </style>
</head>
<body>

<div id="loginOverlay"><button onclick="login()" class="btn-main btn-entry">转专 注 Google</button></div>

<div id="screen-timer" class="screen active">
    <div class="header">
        <div id="currentDateHeader" style="color:var(--accent); font-weight:600"></div>
        <div class="status-text">砖注 转</div>
        <div id="entryDisplay" style="color:var(--gray); font-size:0.9rem"></div>
    </div>
    <div class="timer" id="display">00:00:00</div>
    <div class="stats">
        <div class="stat-item"><span class="stat-val" id="exitTime">--:--</span><span class="stat-label">爪</span></div>
        <div class="stat-item"><span class="stat-val" id="overtimeVal">0.0</span><span class="stat-label">专</span></div>
        <div class="stat-item"><span class="stat-val" id="dayType">'-'</span><span class="stat-label">住 </span></div>
    </div>
    <button id="shiftBtn" class="btn-main btn-entry" onclick="toggleShift()">住</button>
</div>

<div id="screen-report" class="screen">
    <div class="header"><div class="status-text"> 砖</div></div>
    <div style="padding: 10px 20px;"><table id="logTable"></table></div>
</div>

<div id="screen-settings" class="screen">
    <div class="header"><div class="status-text">专转</div></div>
    <div style="padding: 25px;">
        <label style="color:var(--gray); font-size:0.8rem;">转拽 砖注转  拽注</label>
        <input type="number" id="stdInput" value="9" style="width:100%; background:#1C1C1E; border:1px solid #333; color:#fff; padding:15px; border-radius:12px; margin-top:10px; font-size:1.1rem;">
        <button class="btn-main btn-entry" style="margin-top:20px; width:100%" onclick="saveSettings()">砖专 转拽</button>
    </div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="showScreen('timer')"><br>砖注</div>
    <div class="nav-item" onclick="showScreen('report')"><br></div>
    <div class="nav-item" onclick="showScreen('settings')">锔<br>专转</div>
</nav>

<script>
    const firebaseConfig = { apiKey: "AIzaSyB6k04PIDrtH0lN1mMH8d4mrQbU_Wd6EPY", authDomain: "clooc-87768.firebaseapp.com", projectId: "clooc-87768", storageBucket: "clooc-87768.firebasestorage.app", messagingSenderId: "446568496274", appId: "1:446568496274:web:c1aead85e32d21d0e5ba4b" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.firestore();
    let user = null, std = 9, timerInt;

    async function login() { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch(e) { alert("砖转 转专转: " + e.message); } }

    auth.onAuthStateChanged(async u => {
        if(u) {
            user = u;
            document.getElementById('loginOverlay').style.display = 'none';
            const doc = await db.collection('users').doc(user.uid).get();
            if(doc.exists) { std = parseFloat(doc.data().std || 9); document.getElementById('stdInput').value = std; }
            updateHeader(); checkActive(); loadData();
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
    });

    function updateHeader() {
        const days = ["专砖", "砖", "砖砖", "专注", "砖", "砖砖", "砖转"];
        const now = new Date();
        document.getElementById('currentDateHeader').innerText = ` ${days[now.getDay()]} | ${now.toLocaleDateString('he-IL')}`;
    }

    async function toggleShift() {
        const start = localStorage.getItem('active_start');
        if(!start) {
            localStorage.setItem('active_start', new Date().toISOString());
            checkActive();
        } else {
            const btn = document.getElementById('shiftBtn');
            btn.disabled = true; btn.innerText = "砖专...";
            
            const startDay = new Date(start);
            const hours = ((new Date() - startDay) / 3600000).toFixed(2);
            const dateStr = startDay.toLocaleDateString('sv-SE');

            const logEntry = { date: dateStr, hours: parseFloat(hours), timestamp: Date.now() };

            try {
                await db.collection('users').doc(user.uid).collection('logs').add(logEntry);
                localStorage.removeItem('active_start');
                location.reload();
            } catch (e) {
                alert("砖转 住专 注, 住 砖转");
                btn.disabled = false;
                btn.innerText = "住 砖专转";
            }
        }
    }

    function checkActive() {
        const start = localStorage.getItem('active_start');
        if(start) {
            const btn = document.getElementById('shiftBtn');
            btn.innerText = "住 砖专转"; btn.className = "btn-main btn-exit";
            const entry = new Date(start);
            document.getElementById('entryDisplay').innerText = `住: ${entry.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
            
            const dayStd = entry.getDay() === 4 ? std - 1 : std;
            const exit = new Date(entry.getTime() + dayStd * 3600000);
            document.getElementById('exitTime').innerText = exit.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

            timerInt = setInterval(() => {
                const s = Math.floor((new Date() - entry) / 1000);
                let rem = (dayStd * 3600) - s;
                if(rem < 0) { document.getElementById('display').classList.add('overtime'); rem = Math.abs(rem); }
                const h = Math.floor(rem/3600).toString().padStart(2,'0'), m = Math.floor((rem%3600)/60).toString().padStart(2,'0'), sec = (rem%60).toString().padStart(2,'0');
                document.getElementById('display').innerText = `${h}:${m}:${sec}`;
            }, 1000);
        }
    }

    async function loadData() {
        if(!user) return;
        const snap = await db.collection('users').doc(user.uid).collection('logs').orderBy('timestamp', 'desc').get();
        const html = snap.docs.map(doc => {
            const d = doc.data();
            return `<tr><td>${d.date.split('-').reverse().join('/')}</td><td style="text-align:left; font-weight:bold;">${d.hours} 砖注转</td></tr>`;
        }).join('');
        document.getElementById('logTable').innerHTML = html || '<tr><td style="text-align:center"> 转 注</td></tr>';
    }

    async function saveSettings() {
        std = parseFloat(document.getElementById('stdInput').value);
        await db.collection('users').doc(user.uid).set({std: std}, {merge:true});
        alert("专转 砖专"); location.reload();
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
</script>
</body>
</html>
